<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAR - Linha de Impedimento</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #canvas-container {
            position: relative;
            display: inline-block;
            border: 1px solid #000;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        input, button, select {
            margin: 10px;
            padding: 5px;
            font-size: 16px;
        }
        #impedimento-texto {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            font-weight: bold;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: none;
            border-radius: 10px;
        }
        #video-container {
            display: none;
        }
        #video-controls {
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h2>Ferramenta VAR - Linha de Impedimento</h2>

    <input type="file" id="upload" accept="image/*,video/*">
    
    <div id="video-container">
        <video id="video" width="600" controls></video>
        <div id="video-controls">
            <button onclick="playPause()">‚ñ∂Ô∏è / ‚è∏</button>
            <button onclick="rewind()">‚è™ Voltar</button>
            <button onclick="fastForward()">‚è© Avan√ßar</button>
            <input type="range" id="seekBar" min="0" value="0" step="0.1" onchange="seekVideo()">
        </div>
    </div>

    <label for="lineColor">Cor da Linha:</label>
    <input type="color" id="lineColor" value="#ff0000">

    <button onclick="clearLastLine()">Apagar √öltima Linha</button>
    <button onclick="clearLines()">Limpar Tudo</button>
    
    <div id="canvas-container">
        <canvas id="draw-canvas"></canvas>
        <div id="impedimento-texto"></div>
    </div>

    <button onclick="downloadImage()">üì∏ Baixar Imagem</button>
    <button onclick="startRecording()">üé• Gravar V√≠deo</button>
    <button onclick="stopRecording()">‚èπÔ∏è Parar e Baixar V√≠deo</button>

    <script>
        const upload = document.getElementById("upload");
        const video = document.getElementById("video");
        const canvas = document.getElementById("draw-canvas");
        const ctx = canvas.getContext("2d");
        const impedimentoTexto = document.getElementById("impedimento-texto");
        const videoContainer = document.getElementById("video-container");
        const seekBar = document.getElementById("seekBar");
        let lines = [];
        let isVideo = false;
        let mediaRecorder;
        let recordedChunks = [];

        upload.addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            if (file.type.startsWith("video")) {
                isVideo = true;
                video.src = url;
                videoContainer.style.display = "block";
                video.addEventListener("loadedmetadata", () => {
                    seekBar.max = video.duration;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    clearLines();
                });
            } else {
                isVideo = false;
                const img = new Image();
                img.src = url;
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    clearLines();
                };
            }
        });

        canvas.addEventListener("click", (event) => {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            lines.push({ x, color: document.getElementById("lineColor").value });
            drawLines();
        });

        function drawLines() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (isVideo) ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            lines.forEach(line => {
                ctx.beginPath();
                ctx.moveTo(line.x, 0);
                ctx.lineTo(line.x, canvas.height);
                ctx.strokeStyle = line.color;
                ctx.lineWidth = 3;
                ctx.stroke();
            });
        }

        function clearLastLine() {
            if (lines.length > 0) {
                lines.pop();
                drawLines();
            }
        }

        function clearLines() {
            lines = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function downloadImage() {
            const link = document.createElement("a");
            link.download = "linha_impedimento.png";
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        function startRecording() {
            recordedChunks = [];
            const stream = canvas.captureStream(30);
            mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };

            mediaRecorder.start();
        }

        function stopRecording() {
            mediaRecorder.stop();
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "linha_impedimento.webm";
                link.click();
            };
        }

        function playPause() {
            if (video.paused) video.play();
            else video.pause();
        }

        function rewind() {
            video.currentTime -= 1;
        }

        function fastForward() {
            video.currentTime += 1;
        }

        function seekVideo() {
            video.currentTime = seekBar.value;
        }

        video.addEventListener("timeupdate", () => {
            seekBar.value = video.currentTime;
            drawLines();
        });

    </script>

</body>
</html>